<!-- templates/photo_gallery/photo_detail.html -->
<!DOCTYPE html>
<html>
<head>
    <title>{{ photo.title }}</title>
</head>
<body>
    <nav>
    <a href="{% url 'polls:index' %}">ë©”ì¸</a> |
    <a href="{% url 'photo_gallery:photo_list' %}">ê°¤ëŸ¬ë¦¬</a> |
    {% if user.is_authenticated %}
        <a href="{% url 'photo_gallery:photo_create' %}">ì‚¬ì§„ ì—…ë¡œë“œ</a> |
        <a href="{% url 'photo_gallery:my_photos' %}">ë‚´ ì‚¬ì§„</a> |
        <span>{{ user.username }}ë‹˜</span>
        <a href="{% url 'accounts:my_logout' %}">ë¡œê·¸ì•„ì›ƒ</a>
    {% else %}
        <a href="{% url 'accounts:my_login' %}">ë¡œê·¸ì¸</a>
    {% endif %}
    </nav>
    <nav>
        <a href="{% url 'photo_gallery:photo_list' %}">ê°¤ëŸ¬ë¦¬ë¡œ ëŒì•„ê°€ê¸°</a>
    </nav>

    <!-- ì´ì „/ë‹¤ìŒ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div>
        {% if prev_photo %}
            <a href="{% url 'photo_gallery:photo_detail' prev_photo.pk %}">â† ì´ì „ ì‚¬ì§„</a>
        {% endif %}

        {% if next_photo %}
            <a href="{% url 'photo_gallery:photo_detail' next_photo.pk %}">ë‹¤ìŒ ì‚¬ì§„ â†’</a>
        {% endif %}
    </div>

    <!-- ì‚¬ì§„ -->
    <div>
        <img src="{{ photo.photo.url }}" alt="{{ photo.title }}">
    </div>

    <!-- ì‚¬ì§„ ì •ë³´ -->
    <div>
        <h1>{{ photo.title }}</h1>

        <p>ğŸ“· {{ photo.author.username }}</p>
        <p>ğŸ“… {{ photo.photo_date|date:"Yë…„ mì›” dì¼" }}</p>
        <p>ğŸ·ï¸ {{ photo.get_category_display }}</p>
        <p>{% if photo.is_public %}ğŸŒ ê³µê°œ{% else %}ğŸ”’ ë¹„ê³µê°œ{% endif %}</p>

        {% if photo.description %}
        <div>
            {{ photo.description|linebreaks }}
        </div>
        {% endif %}

    <!-- ì¢‹ì•„ìš” ì„¹ì…˜ -->
    <div id="likeSection">
        {% if user.is_authenticated %}
            <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
            <button id="likeBtn"
                    data-photo-id="{{ photo.pk }}"
                    data-url="{% url 'photo_gallery:photo_like_ajax' photo.pk %}"
                    data-liked="{{ user_liked|lower }}">
                {% if user_liked %}
                    â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ
                {% else %}
                    ğŸ¤ ì¢‹ì•„ìš”
                {% endif %}
            </button>

            <!-- ì¢‹ì•„ìš” ìˆ˜ -->
            <span id="likeCount">{{ like_count }}</span>ëª…ì´ ì¢‹ì•„í•©ë‹ˆë‹¤

            <!-- ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
            <div id="message"></div>
        {% else %}
            <p>ë¡œê·¸ì¸í•˜ë©´ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        {% endif %}
    </div>

        <script>
        // CSRF í† í°ì„ ê°€ì ¸ì˜¤ëŠ” í—¬í¼ í•¨ìˆ˜ (Django POST ìš”ì²­ì— í•„ìˆ˜)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // ì¢‹ì•„ìš” ë²„íŠ¼ê³¼ ì¹´ìš´íŠ¸ í‘œì‹œ ì˜ì—­ ê°€ì ¸ì˜¤ê¸°
        const likeBtn = document.getElementById('likeBtn');
        const likeCountSpan = document.getElementById('likeCount');

        // ì¢‹ì•„ìš” ë²„íŠ¼ì´ í˜ì´ì§€ì— ì¡´ì¬í•  ê²½ìš°ì—ë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if (likeBtn) {
            likeBtn.addEventListener('click', function() {
                const photoId = this.dataset.photoId; // data-photo-id ê°’ ê°€ì ¸ì˜¤ê¸°
                const url = `/photo_gallery/${photoId}/like_ajax/`; // Ajax ìš”ì²­ì„ ë³´ë‚¼ URL

                // fetch APIë¥¼ ì‚¬ìš©í•´ ì„œë²„ì— POST ìš”ì²­ ë³´ë‚´ê¸°
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken, // CSRF í† í°ì„ í—¤ë”ì— í¬í•¨
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json()) // ì„œë²„ ì‘ë‹µì„ JSON í˜•íƒœë¡œ íŒŒì‹±
                .then(data => {
                    // ì„œë²„ë¡œë¶€í„° ë°›ì€ ìµœì‹  ë°ì´í„°ë¡œ í™”ë©´ ì—…ë°ì´íŠ¸
                    if (data.user_liked) {
                        // ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ìƒíƒœì¼ ë•Œ
                        likeBtn.innerHTML = 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ';
                    } else {
                        // ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí•œ ìƒíƒœì¼ ë•Œ
                        likeBtn.innerHTML = 'ğŸ¤ ì¢‹ì•„ìš”';
                    }
                    // ì¢‹ì•„ìš” ìˆ«ì ì—…ë°ì´íŠ¸
                    likeCountSpan.textContent = data.like_count;
                })
                .catch(error => console.error('Error:', error)); // ì—ëŸ¬ ì²˜ë¦¬
            });
        }
    </script>
</body>
</html>
